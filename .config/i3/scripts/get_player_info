#!/usr/bin/env bash

# --- get player status once ---
status_raw=$(playerctl status 2>/dev/null || echo "Stopped")

case "$status_raw" in
  "Playing") status="▶" ;;
  "Paused")  status="⏸" ;;
  *)         status="⏹" ;;
esac

# --- if nothing is playing, stop here ---
if [[ $status == "⏹" ]]; then
    echo ""
    exit 0
fi

# --- gather all metadata in one go ---
artist=$(playerctl metadata artist 2>/dev/null)
title=$(playerctl metadata title 2>/dev/null)
metadata=$(playerctl metadata 2>/dev/null)

# --- skip timing for Firefox sources ---
if grep -qi "firefox" <<< "$metadata"; then
    echo "$artist - $title"
    exit 0
fi

# --- get timing safely ---
pos_us=$(playerctl position --format "{{ position }}" 2>/dev/null)
len_us=$(playerctl metadata mpris:length 2>/dev/null)

# default if empty
pos_us=${pos_us:-0}
len_us=${len_us:-0}

pos_s=$(( pos_us / 1000000 ))
len_s=$(( len_us / 1000000 ))

# skip timing if invalid
if [[ $len_s -le 0 ]]; then
    echo "$artist - $title"
    exit 0
fi

# --- format mm:ss ---
current=$(date -u -d@"$pos_s" +'%M:%S')
total=$(date -u -d@"$len_s" +'%M:%S')

# --- final output ---
echo "$$artist - $title ($current/$total)"
