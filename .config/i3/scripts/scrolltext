#!/usr/bin/env bash
# Usage:
#   scrolltext [prefix] <command> [width]
# Examples:
#   scrolltext "Now playing: " "playerctl metadata --format '{{ artist }} - {{ title }}'" 30
#   scrolltext "date '+%A %d %B %Y %H:%M:%S'" 25
#   scrolltext  "echo Hello world" 20

if command -v "${1%% *}" &>/dev/null; then
    prefix=""
    cmd="$1"
    shift
else
    prefix="$1"
    shift
    cmd="$1"
    shift
fi

width="${1:-25}"

if [ -z "$cmd" ]; then
    echo "No command provided"
    exit 1
fi

# --- Command output ---
text="$(eval "$cmd" 2>/dev/null)"
text="${text:-}"

if [ -z "$text" ]; then
    echo ""
    exit 0
fi


# --- If it fits, just print it once ---
if [ "${#text}" -le "$width" ]; then
    printf "%s%s\n" "$prefix" "$text"
    exit 0
fi

# --- Scrolling logic ---
text="$text   "  # padding for smooth wrap
len=${#text}
state_file="/tmp/i3blocks_scroll_state_$(echo "$prefix|$cmd" | md5sum | cut -d' ' -f1)"

if [ -f "$state_file" ]; then
    pos=$(cat "$state_file")
else
    pos=0
fi

total_width="$width"

# Reserve space for the prefix
scroll_width=$(( total_width - ${#prefix} ))
if [ $scroll_width -lt 0 ]; then
    scroll_width=0
fi

# Generate scrolling text
text="$text   "
len=${#text}
state_file="/tmp/i3blocks_scroll_state_$(echo "$prefix|$cmd" | md5sum | cut -d' ' -f1)"

pos=$(cat "$state_file" 2>/dev/null || echo 0)
pos=$(( (pos + 1) % len ))
echo "$pos" > "$state_file"

out="${text}${text}"
scroll="${out:$pos:$scroll_width}"

# Pad the scroll to ensure constant width
printf "%-${total_width}s\n" "${prefix}${scroll}"
